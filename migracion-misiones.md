# Auditoría de datos hardcodeados de misiones V2

## Objetos hardcodeados detectados
- **Tableros por usuaria/o**: cada clave (`user_demo_active`, `user_demo_claim`) contiene un estado completo con `userId`, `seasonId`, `generatedAt` y los slots disponibles.【F:apps/api/data/missions_v2_store.json†L2-L197】【F:apps/api/data/missions_v2_store.json†L641-L800】
- **Slots de misión** (`main`, `hunt`, `skill`) con sus propuestas de mercado (`proposals`) y la misión actualmente seleccionada (`selected`). Las propuestas incluyen narrativa, requisitos, objetivos, recompensas, dificultad, tags y metadatos específicos por misión.【F:apps/api/data/missions_v2_store.json†L8-L145】【F:apps/api/data/missions_v2_store.json†L212-L349】【F:apps/api/data/missions_v2_store.json†L415-L551】
- **Misiones activas por slot** con estado operacional: `status`, timestamps (`selectedAt`, `expiresAt`), progreso cuantitativo (`progress`), seguimiento de pétalos (`petals`), registros de heartbeat (`heartbeatLog`), cooldown y metadatos propios.【F:apps/api/data/missions_v2_store.json†L147-L204】【F:apps/api/data/missions_v2_store.json†L351-L405】【F:apps/api/data/missions_v2_store.json†L553-L607】
- **Catálogo de tareas asociadas** reutilizadas por misión mediante `tasks` con `id`, `name` y `tag`, compartiendo los mismos UUID entre propuestas y slots.【F:apps/api/data/missions_v2_store.json†L31-L41】【F:apps/api/data/missions_v2_store.json†L235-L245】【F:apps/api/data/missions_v2_store.json†L437-L447】
- **Recompensas** con `xp`, `currency` e items listados, incluidos tanto en propuestas como en misiones activas.【F:apps/api/data/missions_v2_store.json†L23-L30】【F:apps/api/data/missions_v2_store.json†L227-L234】【F:apps/api/data/missions_v2_store.json†L559-L566】
- **Componentes de progresión avanzada**: registro de `reroll`, tiempos de `cooldown`, estado del `boss` con escudos y fase 2, además de configuración global del `booster` y lista de `effects` aplicada al tablero.【F:apps/api/data/missions_v2_store.json†L204-L211】【F:apps/api/data/missions_v2_store.json†L351-L405】【F:apps/api/data/missions_v2_store.json†L617-L639】

## Propuesta de estructura relacional
- **missions_seasons**: `season_id` (PK), `label`, `starts_at`, `ends_at` para vincular tableros generados por temporada.
- **mission_slots**: `slot_key` (PK, enum: main/hunt/skill), `description`, `order` para homogeneizar configuraciones por tipo.
- **missions_catalog**: `mission_id` (PK), `slot_key` (FK → mission_slots), `name`, `summary`, `requirements`, `objective`, `difficulty`, `duration_days`, `cadence`, `narrative`, `spotlight`, `stat`, `track`, `booster_multiplier`, `metadata_jsonb` (para campos esporádicos como `window`, `report`).【F:apps/api/data/missions_v2_store.json†L12-L143】【F:apps/api/data/missions_v2_store.json†L216-L347】【F:apps/api/data/missions_v2_store.json†L418-L550】
- **mission_objectives**: `mission_objective_id` (PK), `mission_id` (FK), `position`, `description` para listas ordenadas de objetivos narrativos.【F:apps/api/data/missions_v2_store.json†L18-L21】【F:apps/api/data/missions_v2_store.json†L222-L225】【F:apps/api/data/missions_v2_store.json†L424-L427】
- **mission_rewards**: `mission_id` (PK/FK), `xp`, `currency`; tabla puente **mission_reward_items** (`mission_id`, `item_name`, `position`) para listar ítems de forma normalizada.【F:apps/api/data/missions_v2_store.json†L23-L29】【F:apps/api/data/missions_v2_store.json†L227-L233】【F:apps/api/data/missions_v2_store.json†L475-L481】
- **tasks_catalog**: `task_id` (PK, UUID), `slot_key`, `name`, `tag` para centralizar tareas reutilizables; tabla **mission_tasks** (`mission_id`, `task_id`, `position`) para asignar tareas a cada misión.【F:apps/api/data/missions_v2_store.json†L31-L41】【F:apps/api/data/missions_v2_store.json†L235-L245】【F:apps/api/data/missions_v2_store.json†L437-L447】
- **mission_tags**: `mission_id`, `tag`, `position` para filtros de catálogo.【F:apps/api/data/missions_v2_store.json†L44-L48】【F:apps/api/data/missions_v2_store.json†L248-L252】【F:apps/api/data/missions_v2_store.json†L450-L454】
- **mission_market_proposals**: `proposal_id` (PK), `mission_id` (FK), `order`, `board_slot_key` (FK → mission_slots) para separar la configuración de mercado de la misión base, permitiendo rotación controlada.【F:apps/api/data/missions_v2_store.json†L10-L145】【F:apps/api/data/missions_v2_store.json†L212-L349】【F:apps/api/data/missions_v2_store.json†L415-L551】
- **user_mission_boards**: `board_id` (PK), `user_id` (FK → users), `season_id` (FK → missions_seasons), `generated_at`, `boss_state_jsonb` para encapsular componentes globales como escudos y fase.【F:apps/api/data/missions_v2_store.json†L3-L639】
- **user_slot_states**: `slot_state_id` (PK), `board_id` (FK), `slot_key`, `status`, `selected_mission_id` (FK → missions_catalog), `selected_proposal_id` (FK → mission_market_proposals, nullable), `selected_at`, `expires_at`, `cooldown_until`, `progress_current`, `progress_target`, `progress_unit`, `progress_updated_at`, `reroll_remaining`, `reroll_total`, `reroll_next_reset_at`, `petals_total`, `petals_remaining`, `petals_last_evaluated_at`.
- **mission_heartbeat_logs**: `slot_state_id` (FK), `logged_at` para conservar histórico uno-a-muchos.【F:apps/api/data/missions_v2_store.json†L198-L203】【F:apps/api/data/missions_v2_store.json†L400-L404】【F:apps/api/data/missions_v2_store.json†L603-L606】
- **mission_effects**: `effect_id` (PK), `board_id` (FK), `effect_type`, `payload_jsonb` preparado para futuros boosts permanentes.【F:apps/api/data/missions_v2_store.json†L633-L639】
- **mission_boosters**: `board_id` (PK/FK), `multiplier`, `target_task_id` (FK → tasks_catalog), `next_activation_date`, `applied_keys_jsonb` para preservar el array de slots afectados.【F:apps/api/data/missions_v2_store.json†L633-L638】

## Normalización vs uso de JSONB
- **Normalizar**: catálogo de misiones, tareas, objetivos, recompensas e items para permitir reutilización, traducción y edición independiente sin duplicar texto entre usuarios.【F:apps/api/data/missions_v2_store.json†L12-L143】【F:apps/api/data/missions_v2_store.json†L415-L551】
- **JSONB recomendado**: campos de metadatos opcionales (`window`, `report`, `spotlight`), configuraciones futuras del boss (fase 2, pruebas adjuntas) y listas cortas como `appliedKeys` mientras su estructura varía por feature. Mantener `effects` como JSONB hasta definir taxonomía de efectos persistentes.【F:apps/api/data/missions_v2_store.json†L49-L53】【F:apps/api/data/missions_v2_store.json†L253-L257】【F:apps/api/data/missions_v2_store.json†L617-L639】
- **Estados transaccionales** (progreso, pétalos, heartbeats) deben residir en tablas normalizadas para permitir consultas históricas y garantizar consistencia al sincronizar con tareas diarias.【F:apps/api/data/missions_v2_store.json†L182-L204】【F:apps/api/data/missions_v2_store.json†L385-L405】【F:apps/api/data/missions_v2_store.json†L587-L607】

## Observaciones técnicas para la migración
- El archivo mezcla **definiciones de catálogo** con **estado por usuaria/o**; separar cargas iniciales (seed de misiones y propuestas) de snapshots de progreso al diseñar migraciones.【F:apps/api/data/missions_v2_store.json†L2-L639】
- Los mismos UUID de tareas se repiten en múltiples misiones; al migrar, asegurarse de no duplicar filas sino crear relaciones `mission_tasks` que reutilicen el `task_id`.【F:apps/api/data/missions_v2_store.json†L31-L41】【F:apps/api/data/missions_v2_store.json†L235-L245】【F:apps/api/data/missions_v2_store.json†L437-L447】
- Revisar el modelado de recompensas con múltiples items por misión; conviene soportar orden y posibles cantidades por ítem en la tabla puente para evitar pérdida de semántica.【F:apps/api/data/missions_v2_store.json†L23-L29】【F:apps/api/data/missions_v2_store.json†L227-L233】【F:apps/api/data/missions_v2_store.json†L475-L481】
- El estado del boss y del booster dependen de tareas diarias (`linkedDailyTaskId`, `targetTaskId`); validar integridad referencial contra la base de dailies para evitar referencias huérfanas durante la migración.【F:apps/api/data/missions_v2_store.json†L624-L636】
- Preparar scripts de migración que conviertan `heartbeatLog` en registros individuales y calculen métricas derivadas (progress, petals) para cada slot, permitiendo analytics posteriores y limpieza de datos inconsistentes.【F:apps/api/data/missions_v2_store.json†L188-L204】【F:apps/api/data/missions_v2_store.json†L391-L405】【F:apps/api/data/missions_v2_store.json†L593-L607】
