# EspecificaciÃ³n del editor de base de datos (auditorÃ­a del MVP)

## 1. Campos de tarea utilizados en el MVP
- El estado central (`state.rows`) modela cada fila como un arreglo de seis posiciones en orden fijo: `[Pilar, Rasgo, Stat, Task, Dificultad, Feedback]`. Las cinco primeras columnas se guardan y sincronizan con la API; la sexta es un flag local para feedback/acciones de IA.ã€F:MVP/bbdd.jsâ€ L43-L47ã€‘ã€F:MVP/bbdd.jsâ€ L210-L218ã€‘
- Los valores persistidos se normalizan antes de guardar: `Pilar` se limita a Body/Mind/Soul mediante `normPilar`, `Rasgo` usa `cleanRasgo` para quitar sufijos, `Stat`/`Task` son texto libre, `Dificultad` pasa por `normDiff` y solo acepta FÃ¡cil/Media/DifÃ­cil. `Feedback` solo admite "improve" o "replace" y no viaja al backend.ã€F:MVP/bbdd.jsâ€ L32-L40ã€‘ã€F:MVP/bbdd.jsâ€ L202-L215ã€‘ã€F:MVP/bbdd.jsâ€ L248-L282ã€‘
- La UI mÃ³vil recompone cada `<tr>` en una tarjeta tÃ¡ctil que sigue consumiendo los mismos campos y sincroniza cambios contra `state.rows`, incluida la marca `__aiMode` cuando la IA modifica una task.ã€F:MVP/index-bbdd.htmlâ€ L1127-L1207ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1389-L1417ã€‘

## 2. Flujo actual de alta, ediciÃ³n y borrado
1. **Carga inicial** (`init`): obtiene el email desde query/localStorage, configura listeners y llama a `apiGetBBDD`, que trae `rows` (matriz Aâ€“E). Se filtran filas sin Task y se extienden con un slot vacÃ­o para feedback antes de renderizar.ã€F:MVP/bbdd.jsâ€ L74-L121ã€‘ã€F:MVP/bbdd.jsâ€ L486-L532ã€‘
2. **Render**: `render()` transforma cada fila en `<tr>` con controles editables, asigna `data-index` y muestra el indicador de cambios pendientes (`state.dirty`). TambiÃ©n asocia eventos de input, click y drag & drop.ã€F:MVP/bbdd.jsâ€ L122-L198ã€‘
3. **Alta de fila**: el botÃ³n `#add-row` inserta `["","","","","",""]` en `state.rows` y repinta. En mÃ³vil, el botÃ³n duplicado `#add-row-dup` despacha el mismo handler.ã€F:MVP/bbdd.jsâ€ L430-L435ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1028-L1041ã€‘
4. **EdiciÃ³n**: cada control sincroniza su valor con `state.rows` mediante `onRowInput`, que normaliza segÃºn la columna, marca el estado como sucio y, si cambia el pilar, fuerza un rerender para recalcular los rasgos. La vista mÃ³vil replica esta lÃ³gica para dificultad, meta y toggles expandidos.ã€F:MVP/bbdd.jsâ€ L200-L244ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1227-L1299ã€‘
5. **Borrado**: el botÃ³n X (desktop) o la acciÃ³n ğŸ—‘ï¸ (mÃ³vil) elimina la fila, reindexa `state.aiUpdated` y vuelve a renderizar.ã€F:MVP/bbdd.jsâ€ L246-L268ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1418-L1440ã€‘
6. **Guardado simple** (`doSave`): normaliza filas visibles, valida pilar y task, POSTea a `/bbdd`, reinicia `state.dirty` y el set de IA, y muestra un toast.ã€F:MVP/bbdd.jsâ€ L296-L314ã€‘
7. **ConfirmaciÃ³n** (`doConfirm`): vuelve a guardar, interpreta la respuesta (`estado`), condiciona el toast y, salvo estado "constante", llama a `/bbdd/confirm` para disparar el flujo de onboarding. TambiÃ©n maneja UI de loading y notifica al dashboard/overlay.ã€F:MVP/bbdd.jsâ€ L316-L387ã€‘
8. **IA opcional**: selecciÃ³n por feedback (`aiBuildSelection`), envÃ­o en lotes a `aiSendBatch`, aplicaciÃ³n de resultados y marca de filas con `state.aiUpdated`. La vista mÃ³vil aÃ±ade accesos directos por fila (`runAiForRow`).ã€F:MVP/bbdd.jsâ€ L356-L446ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1399-L1435ã€‘

## 3. Supuestos de catÃ¡logo
- **Pilares**: catÃ¡logo fijo `["Body","Mind","Soul"]`. La normalizaciÃ³n acepta alias en espaÃ±ol/inglÃ©s y minÃºsculas (p. ej. "cuerpo" â†’ Body).ã€F:MVP/bbdd.jsâ€ L8-L36ã€‘
- **Rasgos**: diccionario `RASGOS_POR_PILAR` con 10 rasgos por pilar; se usa para poblar `<select>` y validar que un rasgo sea coherente cuando cambia el pilar.ã€F:MVP/bbdd.jsâ€ L10-L18ã€‘ã€F:MVP/bbdd.jsâ€ L204-L223ã€‘
- **Stats**: texto libre sin catÃ¡logo, pero la UI mÃ³vil lo trata como metadato editable debajo de la task.ã€F:MVP/bbdd.jsâ€ L139-L150ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1189-L1222ã€‘
- **Dificultad**: catÃ¡logo `["FÃ¡cil","Media","DifÃ­cil"]` con normalizaciÃ³n de acentos y alias. El chip mÃ³vil cicla entre esos valores y sincroniza el `<select>` oculto.ã€F:MVP/bbdd.jsâ€ L9-L40ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1245-L1299ã€‘
- **Feedback IA**: valores simbÃ³licos "improve"/"replace" almacenados localmente para disparar IA; no se persisten ni viajan a la API.ã€F:MVP/bbdd.jsâ€ L148-L151ã€‘ã€F:MVP/bbdd.jsâ€ L356-L401ã€‘

## 4. Limitaciones y oportunidades de mejora en UX mÃ³vil
- **HTML/CSS redundante**: la hoja de estilos embebida contiene mÃºltiples bloques repetidos y parches secuenciales (varias redefiniciones de `.bbdd-panel`, `header.appbar`, `#bbdd-confirm`), lo que complica mantenimiento y puede generar conflictos al portarlo a componentes modulares.ã€F:MVP/index-bbdd.htmlâ€ L62-L456ã€‘ã€F:MVP/index-bbdd.htmlâ€ L440-L821ã€‘
- **Transformaciones DOM manuales**: el script mÃ³vil reemplaza cada `<tr>` por tarjetas y gestiona swipe, expansiÃ³n y sincronizaciÃ³n mediante `MutationObserver`, lo que introduce complejidad y riesgo de desincronizaciÃ³n en frameworks reactivos. Migrarlo a componentes declarativos permitirÃ­a reutilizar lÃ³gica y tests.ã€F:MVP/index-bbdd.htmlâ€ L1072-L1440ã€‘
- **GestiÃ³n de gestos personalizada**: `makeSwipeable` implementa a mano thresholds y listeners para arrastre lateral. Al refactorizar se puede delegar en librerÃ­as de gestos o APIs pointer modernas para consistencia cross-platform y accesibilidad.ã€F:MVP/index-bbdd.htmlâ€ L1324-L1417ã€‘
- **Carga cognitiva en confirmaciÃ³n**: se superponen mÃºltiples overlays (spinner de tabla, `aiLoading`, `saving-shield`, botÃ³n flotante). Integrar estados en un solo store permitirÃ­a mensajes mÃ¡s claros y evitar bloqueo redundante de controles.ã€F:MVP/bbdd.jsâ€ L290-L387ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1461-L1713ã€‘
- **Accesibilidad limitada**: aunque se aÃ±ade `aria-label` en botones swipe, la reconstrucciÃ³n dinÃ¡mica elimina encabezados de tabla y podrÃ­a dificultar la navegaciÃ³n con lectores de pantalla. Una migraciÃ³n a componentes semÃ¡nticos (listas con `role` adecuado) puede mejorar soporte asistivo.ã€F:MVP/index-bbdd.htmlâ€ L1131-L1216ã€‘

## 5. Diferencias previstas al integrarlo con la arquitectura actual
- **Ecosistema**: el MVP es vanilla JS con globals (`window.openBBDD`, `window.doConfirm`, `state`). La app actual es React + TypeScript (Vite) en `apps/web`, por lo que habrÃ¡ que encapsular la lÃ³gica en hooks/contexts o stores (e.g. Zustand) en lugar de mutar `window` y usar `document.querySelector` directo.ã€F:MVP/bbdd.jsâ€ L58-L65ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1000-L1053ã€‘ã€F:apps/web/src/main.tsxâ€ L1-L39ã€‘
- **GestiÃ³n de rutas**: hoy la vista depende de parÃ¡metros `email`/`back` en la URL y del modo `modal`. En la nueva arquitectura deberÃ­a integrarse con el enrutador existente y los guardias de autenticaciÃ³n que ya envuelven las rutas (p. ej. `RequireUser`), evitando rely en `localStorage` ad-hoc para sesiÃ³n.ã€F:MVP/bbdd.jsâ€ L66-L72ã€‘ã€F:MVP/bbdd.jsâ€ L404-L455ã€‘ã€F:apps/web/src/App.tsxâ€ L1-L116ã€‘
- **Imports y mÃ³dulos**: funciones como `apiGetBBDD`, normalizadores y utilidades deberÃ¡n exportarse desde mÃ³dulos TS, reemplazando el uso global de `fetch` con helpers de cliente ya usados en la app (por ejemplo, `apiRequest` y la configuraciÃ³n del token Clerk). TambiÃ©n habrÃ¡ que mover constantes (`API_BASE`, `PROXY_KEY`) a configuraciÃ³n por entorno para alinearse con las variables `VITE_API_BASE_URL` usadas hoy.ã€F:MVP/bbdd.jsâ€ L4-L25ã€‘ã€F:apps/web/src/lib/api.tsâ€ L1-L120ã€‘ã€F:apps/web/src/lib/api.tsâ€ L199-L346ã€‘
- **Estado y efectos**: `render()` manipula el DOM manualmente; en React la representaciÃ³n de filas y tarjetas debe derivar del estado y efectos (`useEffect`) con listas keyeadas. La sincronizaciÃ³n de IA y drag & drop deberÃ­a apoyarse en librerÃ­as compatibles o patrones ya presentes (por ejemplo, el modal de Daily Quest usa hooks y refs para coordinaciÃ³n) en vez de listeners nativos globales.ã€F:MVP/bbdd.jsâ€ L122-L198ã€‘ã€F:MVP/index-bbdd.htmlâ€ L1230-L1440ã€‘ã€F:apps/web/src/components/DailyQuestModal.tsxâ€ L288-L366ã€‘
- **Cliente API**: el MVP llama al Worker con headers personalizados (`X-Proxy-Key`) y cookies `include`. Integrarlo requerirÃ¡ usar el cliente oficial (`apiRequest` + `setApiAuthTokenProvider`) que centraliza base URLs, autenticaciÃ³n Clerk y logging, evitando exponer llaves en el bundle.ã€F:MVP/bbdd.jsâ€ L76-L118ã€‘ã€F:apps/web/src/lib/api.tsâ€ L1-L120ã€‘ã€F:apps/web/src/lib/api.tsâ€ L199-L346ã€‘

> Esta especificaciÃ³n documenta el estado actual del MVP para orientar el refactor hacia componentes tipados, reutilizando catÃ¡logos globales y los servicios existentes en la aplicaciÃ³n principal.
