<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Self-Improvement Journey</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/formsintrov2.css?v=3">
</head>
<body>

<!-- HUD -->
<header class="hud">
  <div class="brand">
    <span class="dot"></span>
    <div class="journey">
      <span id="hudTitle">Journey</span>
      <div class="progress"><div id="progressFill" class="fill"></div></div>
    </div>
  </div>
  <div class="mid">
    <div class="pill">
      <div class="row"><span class="emoji">ğŸ«€</span><span class="label">Body</span></div>
      <progress id="barBody" value="0" max="100"></progress>
    </div>
    <div class="pill">
      <div class="row"><span class="emoji">ğŸ§ </span><span class="label">Mind</span></div>
      <progress id="barMind" value="0" max="100"></progress>
    </div>
    <div class="pill">
      <div class="row"><span class="emoji">ğŸµï¸</span><span class="label">Soul</span></div>
      <progress id="barSoul" value="0" max="100"></progress>
    </div>
  </div>
  <div class="xp">XP: <span id="xpTotal">0</span></div>
</header>

<!-- PÃ¡gina -->
<main class="overlay page">
  <div class="modal">

    <!-- Intro -->
    <section class="scr active" id="scr-intro">
      <div class="hero">
        <div>
          <h2>Cap. 0 â€” El Despertar</h2>
          <p>RespirÃ¡. Hoy enciendes tu sistema de mejora. Te voy guiando para equilibrar <strong>Cuerpo, Mente y Alma</strong> con pasos simples.</p>
          <p><strong>CÃ³mo funciona:</strong> por cada pregunta que completes vas a ir sumando puntos de experiencia <strong>(XP)</strong>. Algunas valen <em>+21 XP</em> (respuestas escritas o clave de modo) y otras <em>+13 XP</em> (selecciones).</p>
          <div class="field" style="margin:12px 0">
            <label for="emailInput">Tu correo (obligatorio)</label>
            <input
              id="emailInput"
              name="email"
              type="email"
              placeholder="tu@email.com"
              autocomplete="email"
              autocapitalize="none"
              spellcheck="false"
              inputmode="email"
              enterkeyhint="go"
              required
            />
            <small style="color:#aab7ff">Lo usamos para crear tu tablero y guardar tu progreso.</small>
          </div>
          <div class="nav">
            <button class="btn secondary" id="backIntroDisabled" disabled>â€”</button>
            <button class="btn" id="goModes" disabled>Comenzar</button>
          </div>
        </div>
        <figure class="pic">
          <img src="https://i.ibb.co/1GdbMQ1f/7e5cbb24-ebfe-4b0f-bbae-bddc1b66451a.jpg" alt="Intro">
        </figure>
      </div>
    </section>

    <!-- Game Modes -->
    <section class="scr" id="scr-modes">
      <div class="hero">
        <div>
          <h2>ElegÃ­ tu Game Mode</h2>
          <p>ElegÃ­ el <strong>modo</strong> que mejor describe tu estado <strong>hoy</strong> para adaptar el recorrido a tu energÃ­a y enfoque.</p>
          <div class="grid" id="modeGrid">
            <div class="card" data-mode="LOW"><h3>ğŸª« LOW MOOD</h3><p class="note">EnergÃ­a baja. Activamos tu mÃ­nimo vital con acciones pequeÃ±as y seguras.</p></div>
            <div class="card" data-mode="CHILL"><h3>ğŸŒ¿ CHILL MOOD</h3><p class="note">Tranquilo / estable. Sostener bienestar con rutinas suaves y balance.</p></div>
            <div class="card" data-mode="FLOW"><h3>ğŸŒŠ FLOW MOOD</h3><p class="note">Enfocado. Alineamos tu impulso con una meta clara sin descuidar el bienestar.</p></div>
            <div class="card" data-mode="EVOLVE"><h3>ğŸ§¬ EVOLVE MOOD</h3><p class="note">AmbiciÃ³n con propÃ³sito. Subimos de nivel con misiones y foco sostenible.</p></div>
          </div>
          <div class="nav">
            <button class="btn secondary" id="backIntro">Volver</button>
            <button class="btn" id="confirmMode" disabled>Confirmar modo</button>
          </div>
        </div>
        <figure class="pic">
          <img src="https://i.ibb.co/VcWFCZkL/b79005b1-97d9-4aa9-85dd-239861bb6c5c.jpg" alt="Modos">
        </figure>
      </div>
    </section>

    <!-- ====== LOW -->
    <section class="scr" id="scr-low-body" data-type="checklist" data-pillar="Body" data-xp="13" data-limit="5">
      <h2>LOW Â· ğŸ«€ Body</h2>
      <p>ElegÃ­ hasta <strong>5</strong> acciones simples que te harÃ­an bien ahora. <span class="xp-badge">+13 XP</span></p>
      <div class="checklist" id="lowBodyList"></div>
      <div class="counter"><span id="lowBodyCount">0</span>/5 seleccionadas (obligatorio)</div>

      <div class="open-title">Â¿Hay algo que te cueste o quieras evitar a nivel fÃ­sico? <span class="xp-badge">+21 XP</span></div>
      <p class="note">PodÃ©s mencionar hÃ¡bitos, dolores o ambientes que te incomodanâ€¦ (opcional)</p>
      <textarea id="fBodyOpen" rows="4" placeholder="EscribÃ­ si querÃ©sâ€¦ (opcional)"></textarea>

      <div class="nav">
        <button class="btn secondary" id="backToModes1">Volver</button>
        <button class="btn" id="confirmLowBody" disabled>Confirmar</button>
      </div>
    </section>

    <section class="scr" id="scr-low-soul" data-type="checklist" data-pillar="Soul" data-xp="13" data-limit="5">
      <h2>LOW Â· ğŸµï¸ Soul</h2>
      <p>ElegÃ­ hasta <strong>5</strong> cosas simples que te conectan con vos. <span class="xp-badge">+13 XP</span></p>
      <div class="checklist" id="lowSoulList"></div>
      <div class="counter"><span id="lowSoulCount">0</span>/5 seleccionadas (obligatorio)</div>

      <div class="open-title">Â¿QuÃ© tipo de prÃ¡cticas espirituales te gustarÃ­a probar o retomar? <span class="xp-badge">+21 XP</span></div>
      <p class="note">PodÃ©s incluir ejemplos personalesâ€¦ (opcional)</p>
      <textarea id="fSoulOpen" rows="4" placeholder="EscribÃ­ si querÃ©sâ€¦ (opcional)"></textarea>

      <div class="nav">
        <button class="btn secondary" id="backLowBody">Volver</button>
        <button class="btn" id="confirmLowSoul" disabled>Confirmar</button>
      </div>
    </section>

    <section class="scr" id="scr-low-mind" data-type="checklist" data-pillar="Mind" data-xp="13" data-limit="5">
      <h2>LOW Â· ğŸ§  Mind</h2>
      <p>ElegÃ­ hasta <strong>5</strong> acciones mentales que te ayuden hoy. <span class="xp-badge">+13 XP</span></p>
      <div class="checklist" id="lowMindList"></div>
      <div class="counter"><span id="lowMindCount">0</span>/5 seleccionadas (obligatorio)</div>

      <div class="open-title">Â¿QuÃ© te gustarÃ­a lograr con tu desarrollo mental? <span class="xp-badge">+21 XP</span></div>
      <p class="note">Por ejemplo: leer mÃ¡s, organizar mejor el tiempo, mantenerte enfocadoâ€¦ (opcional)</p>
      <textarea id="fMindOpen" rows="4" placeholder="EscribÃ­ si querÃ©sâ€¦ (opcional)"></textarea>

      <div class="nav">
        <button class="btn secondary" id="backLowSoul">Volver</button>
        <button class="btn" id="confirmLowMind" disabled>Confirmar</button>
      </div>
    </section>

    <!-- Low Â· comentario final -->
    <section class="scr" id="scr-low-note" data-type="open" data-xp="21">
      <h2>LOW Â· Â¿QuerÃ©s contarnos algo mÃ¡s?</h2>
      <p class="note">Es opcional: solo una IA lo revisarÃ¡. PodÃ©s dejarlo en blanco si no querÃ©s.</p>
      <textarea id="lowNote" rows="4" placeholder="(opcional)"></textarea>
      <div class="nav">
        <button class="btn secondary" id="backLowMind">Volver</button>
        <button class="btn" id="confirmLowNote">Continuar</button>
      </div>
    </section>

    <!-- ====== CHILL -->
    <section class="scr" id="scr-chill-open" data-type="open21">
      <div class="hero">
        <div>
          <h2>CHILL Â· Una cosa este mes <span class="xp-badge">+21 XP</span></h2>
          <p>Si pudieras mejorar o lograr <strong>solo una cosa</strong> este mes, Â¿cuÃ¡l serÃ­a?</p>
          <textarea id="chillOneThing" rows="4" placeholder="EscribÃ­ tu respuestaâ€¦ (obligatoria)"></textarea>
          <div class="nav">
            <button class="btn secondary" id="backToModes2">Volver</button>
            <button class="btn" id="confirmChillOpen" disabled>Confirmar</button>
          </div>
        </div>
        <figure class="pic"><img src="https://i.ibb.co/DDvczhR5/1e2bc15a-9f87-47b7-9b5b-c28156b69f0f.jpg" alt="Chill"></figure>
      </div>
    </section>

    <section class="scr" id="scr-chill-motiv" data-type="mode13">
      <h2>CHILL Â· Â¿QuÃ© te impulsa mÃ¡s? <span class="xp-badge">+13 XP</span></h2>
      <p>ElegÃ­ las que sientas (al menos una).</p>
      <div class="checklist" id="chillMotivList"></div>
      <div class="nav">
        <button class="btn secondary" id="backChillOpen">Volver</button>
        <button class="btn" id="confirmChillMotiv" disabled>Confirmar</button>
      </div>
    </section>

    <!-- ====== FLOW -->
    <section class="scr" id="scr-flow-goal" data-type="open21">
      <div class="hero">
        <div>
          <h2>FLOW Â· Tu objetivo <span class="xp-badge">+21 XP</span></h2>
          <p>Â¿CuÃ¡l es tu objetivo en este momento?</p>
          <textarea id="flowGoal" rows="4" placeholder="EscribÃ­ tu objetivoâ€¦ (obligatorio)"></textarea>
          <div class="nav">
            <button class="btn secondary" id="backToModes3">Volver</button>
            <button class="btn" id="confirmFlowGoal" disabled>Confirmar</button>
          </div>
        </div>
        <figure class="pic"><img src="https://i.ibb.co/DDvczhR5/1e2bc15a-9f87-47b7-9b5b-c28156b69f0f.jpg" alt="Flow"></figure>
      </div>
    </section>

    <section class="scr" id="scr-flow-imped" data-type="mode13">
      <h2>FLOW Â· Â¿QuÃ© te lo viene impidiendo? <span class="xp-badge">+13 XP</span></h2>
      <p>ElegÃ­ las que apliquen (al menos una).</p>
      <div class="checklist" id="flowImpedList"></div>
      <div class="nav">
        <button class="btn secondary" id="backFlowGoal">Volver</button>
        <button class="btn" id="confirmFlowImped" disabled>Confirmar</button>
      </div>
    </section>

    <!-- ====== EVOLVE -->
    <section class="scr" id="scr-evolve-goal" data-type="open21">
      <div class="hero">
        <div>
          <h2>EVOLVE Â· Objetivo desafiante <span class="xp-badge">+21 XP</span></h2>
          <p>Â¿CuÃ¡l es tu objetivo desafiante?</p>
          <textarea id="evolveGoal" rows="4" placeholder="EscribÃ­ tu objetivoâ€¦ (obligatorio)"></textarea>
          <div class="nav">
            <button class="btn secondary" id="backToModes4">Volver</button>
            <button class="btn" id="confirmEvolveGoal" disabled>Confirmar</button>
          </div>
        </div>
        <figure class="pic"><img src="https://i.ibb.co/DDvczhR5/1e2bc15a-9f87-47b7-9b5b-c28156b69f0f.jpg" alt="Evolve"></figure>
      </div>
    </section>

    <section class="scr" id="scr-evolve-trade" data-type="mode13">
      <h2>EVOLVE Â· Â¿QuÃ© estÃ¡s dispuesto a ajustar? <span class="xp-badge">+13 XP</span></h2>
      <p>ElegÃ­ las que apliquen (al menos una).</p>
      <div class="checklist" id="evolveTradeList"></div>
      <div class="nav">
        <button class="btn secondary" id="backEvolveGoal">Volver</button>
        <button class="btn" id="confirmEvolveTrade" disabled>Confirmar</button>
      </div>
    </section>

    <section class="scr" id="scr-evolve-att" data-type="mode21-radio">
      <h2>EVOLVE Â· Actitud ante el cambio <span class="xp-badge">+21 XP</span></h2>
      <p>ElegÃ­ una opciÃ³n.</p>
      <div class="checklist" id="evolveAttList"></div>
      <div class="nav">
        <button class="btn secondary" id="backEvolveTrade">Volver</button>
        <button class="btn" id="confirmEvolveAtt" disabled>Confirmar</button>
      </div>
    </section>

    <!-- ====== FOUNDATIONS -->
    <section class="scr" id="scr-f-body" data-type="checklist" data-pillar="Body" data-xp="13" data-limit="5">
      <h2>Foundations Â· ğŸ«€ Body</h2>
      <p>Lo fÃ­sico es tu base. ElegÃ­ hasta <strong>5</strong> anclas. <span class="xp-badge">+13 XP</span></p>
      <div class="checklist" id="fBodyList"></div>
      <div class="counter"><span id="fBodyCount">0</span>/5 seleccionadas (obligatorio)</div>

      <div class="open-title">Â¿Hay algo que te cueste o quieras evitar a nivel fÃ­sico? <span class="xp-badge">+21 XP</span></div>
      <p class="note">PodÃ©s mencionar hÃ¡bitos, dolores o ambientes que te incomodanâ€¦ (opcional)</p>
      <textarea id="fBodyOpen2" rows="4" placeholder="EscribÃ­ si querÃ©sâ€¦ (opcional)"></textarea>

      <div class="nav">
        <button class="btn secondary" id="backFoundPrev1">Volver</button>
        <button class="btn" id="confirmFBody" disabled>Confirmar</button>
      </div>
    </section>

    <section class="scr" id="scr-f-soul" data-type="checklist" data-pillar="Soul" data-xp="13" data-limit="5">
      <h2>Foundations Â· ğŸµï¸ Soul</h2>
      <p>Sin centro, no hay llegada. ElegÃ­ hasta <strong>5</strong> prÃ¡cticas. <span class="xp-badge">+13 XP</span></p>
      <div class="checklist" id="fSoulList"></div>
      <div class="counter"><span id="fSoulCount">0</span>/5 seleccionadas (obligatorio)</div>

      <div class="open-title">Â¿QuÃ© tipo de prÃ¡cticas espirituales te gustarÃ­a probar o retomar? <span class="xp-badge">+21 XP</span></div>
      <p class="note">PodÃ©s incluir ejemplos personalesâ€¦ (opcional)</p>
      <textarea id="fSoulOpen2" rows="4" placeholder="EscribÃ­ si querÃ©sâ€¦ (opcional)"></textarea>

      <div class="nav">
        <button class="btn secondary" id="backFBody">Volver</button>
        <button class="btn" id="confirmFSoul" disabled>Confirmar</button>
      </div>
    </section>

    <section class="scr" id="scr-f-mind" data-type="checklist" data-pillar="Mind" data-xp="13" data-limit="5">
      <h2>Foundations Â· ğŸ§  Mind</h2>
      <p>No es hacer mÃ¡s: es <strong>hacer mejor</strong>. ElegÃ­ hasta <strong>5</strong> focos. <span class="xp-badge">+13 XP</span></p>
      <div class="checklist" id="fMindList"></div>
      <div class="counter"><span id="fMindCount">0</span>/5 seleccionadas (obligatorio)</div>

      <div class="open-title">Â¿QuÃ© te gustarÃ­a lograr con tu desarrollo mental? <span class="xp-badge">+21 XP</span></div>
      <p class="note">Por ejemplo: leer mÃ¡s, organizar mejor el tiempo, mantenerte enfocadoâ€¦ (opcional)</p>
      <textarea id="fMindOpen2" rows="4" placeholder="EscribÃ­ si querÃ©sâ€¦ (opcional)"></textarea>

      <div class="nav">
        <button class="btn secondary" id="backFSoul">Volver</button>
        <button class="btn" id="confirmFMind" disabled>Confirmar</button>
      </div>
    </section>

    <!-- ====== RESUMEN -->
    <section class="scr" id="scr-summary">
      <h2>Â¡Todo listo para empezar! ğŸš€</h2>
      <div class="summary-box" id="summaryBox"></div>
      <p class="note" style="margin-top:10px">
        <strong>CapitÃ¡n</strong>, con esto generamos tus <strong>primeras tasks</strong> y un plan simple para hoy.
        Vas a poder ver tu avance y reacomodar prioridades en tu <strong>tablero personal</strong>, pero lo importante es el <em>ritmo</em>:
        pasos cortos, XP real, progreso visible.
      </p>
      <div class="nav">
        <button class="btn secondary" id="restart">Volver al inicio</button>
        <button class="btn" id="finish">Comenzar Journey</button>
      </div>
    </section>

    <!-- toasts listos (solo visuales, sin lÃ³gica aÃºn) -->
    <div id="toast13" class="toast">+13 XP</div>
    <div id="toast21" class="toast">+21 XP</div>

  </div> <!-- cierra .modal -->
</main>
<div id="toast" class="toast"></div>


 <script>
// ==========================
// 1) Etiquetas 1:1 con el Form (copiadas del prellenado)
// ==========================
const FORM_LABELS = {
  // LOW
  lowBody: [
    "Dormir mejor ğŸ˜´",
    "Alimentarte mejor ğŸ¥—",
    "Moverte un poco mÃ¡s ğŸƒ",
    "Tomar mÃ¡s agua ğŸ’§",
    "Descansar sin culpa ğŸ§˜"
  ],
  lowSoul: [
    "Respirar profundo unos minutos ğŸŒ¬ï¸",
    "Escuchar mÃºsica que te gusta ğŸ¶",
    "Estar en contacto con la naturaleza ğŸƒ",
    "Anotar lo que sentÃ­s en un papel ğŸ“",
    "Hacer algo sin tener que ser Ãºtil ğŸŒˆ"
  ],
  lowMind: [
    "Leer algo corto ğŸ“–",
    "Anotar tus pensamientos ğŸ““",
    "Mirar una serie tranquila ğŸ“º",
    "Hacer una pausa sin pantallas ğŸš«ğŸ“±",
    "Desarmar alguna idea negativa ğŸ§©"
  ],

  // CHILL â€” Motivaciones
  chillMotiv: [
    "ğŸŒ± Crecer como persona / desarrollo personal",
    "ğŸ¯ Lograr metas concretas que me propongo",
    "ğŸ¤ Sentirme mÃ¡s conectado con otras personas",
    "ğŸ§˜â€â™‚ï¸ Vivir con mÃ¡s calma y menos estrÃ©s",
    "ğŸ† Superarme a mÃ­ mismo y romper mis lÃ­mites",
    "ğŸ› ï¸ Crear o construir algo (proyectos, arte, emprendimientos)",
    "âœ¨ Sentirme mÃ¡s feliz y satisfecho con mi dÃ­a a dÃ­a",
    "ğŸ—ºï¸ Tener mÃ¡s experiencias y aventuras",
    "ğŸ’– Cuidar mi salud y bienestar a largo plazo"
  ],

  flowObstacles: [
    "Falta de tiempo",
    "Falta de energÃ­a o motivaciÃ³n",
    "Miedo al fracaso",
    "Dudas sobre dÃ³nde empezar",
    "Falta de apoyo",
    "ProcrastinaciÃ³n",
    "No tengo HÃ¡bitos aÃºn",
    "SÃ­ndrome del impostor"
  ],

  evolveCommit: [
    "Mis hÃ¡bitos diarios",
    "Mi alimentaciÃ³n",
    "Mis rutinas de descanso",
    "Mi tiempo libre",
    "Mis relaciones sociales",
    "Mis creencias y bloqueos mentales",
    "Mis espacios fÃ­sicos"
  ],
  evolveAtt: [
    "Estoy muy motivado y quiero cambios ya",
    "Quiero ir de a poco pero con foco",
    "Me cuesta mantener constancia pero quiero intentar"
  ],

  // FOUNDATIONS â€” Body
  fBody: [
    "ğŸƒâ€â™‚ï¸ Actividad fÃ­sica regular (EnergÃ­a)",
    "ğŸ¥— AlimentaciÃ³n saludable (NutriciÃ³n)",
    "ğŸ˜´ Dormir y descansar mejor (SueÃ±o)",
    "ğŸ›€ RelajaciÃ³n y pausas para recuperar el cuerpo (RecuperaciÃ³n)",
    "ğŸ’§ Tomar mÃ¡s agua o hidratarte mejor (HidrataciÃ³n)",
    "ğŸ§¼ Higiene y cuidado personal diario (Higiene)",
    "ğŸŒ… Sentirte con mÃ¡s energÃ­a y vitalidad al despertar (Vitalidad)",
    "ğŸ’º Mejorar tu postura y ergonomÃ­a (Postura)",
    "ğŸ§˜â€â™‚ï¸ Flexibilidad y movilidad corporal (Movilidad)",
    "ğŸš« Reducir consumo de alcohol, tabaco o cafeÃ­na (ModeraciÃ³n)"
  ],

  fSoul: [
    "ğŸ¤ Fortalecer relaciones y vÃ­nculos personales (ConexiÃ³n)",
    "ğŸŒŒ Practicar espiritualidad o sentir plenitud interior (Espiritualidad)",
    "ğŸ¯ Definir tu propÃ³sito y direcciÃ³n en la vida (PropÃ³sito)",
    "âš–ï¸ Vivir mÃ¡s alineado a tus valores (Valores)",
    "ğŸ’— Ayudar a otros o aportar a una causa (Altruismo)",
    "ğŸ” Conocerte mÃ¡s profundamente (Insight)",
    "ğŸ™ Practicar gratitud o tener una actitud positiva (Gratitud)",
    "ğŸŒ³ Conectarte mÃ¡s con la naturaleza (Naturaleza)",
    "ğŸ‰ Jugar, reÃ­r y divertirte sin culpa (Gozo)",
    "ğŸª Trabajar tu autoestima y hablarte con mÃ¡s amabilidad (Autoestima)"
  ],

  fMind: [
    "ğŸ¯ Mejorar tu enfoque y productividad diaria (Enfoque)",
    "ğŸ“š Aprender cosas nuevas o estudiar mejor (Aprendizaje)",
    "ğŸ¨ Desarrollar tu creatividad e ideas nuevas (Creatividad)",
    "ğŸ˜µâ€ğŸ’« Manejar mejor el estrÃ©s o ansiedad (GestiÃ³n)",
    "ğŸ§  Regular tus emociones y reacciones (Autocontrol)",
    "ğŸ’ª Ser mÃ¡s resiliente frente a desafÃ­os (Resiliencia)",
    "ğŸ—‚ï¸ Tener tus tareas o espacios mentales mÃ¡s organizados (Orden)",
    "ğŸš€ Desarrollarte profesionalmente o avanzar en tu carrera (ProyecciÃ³n)",
    "ğŸ’° Mejorar tus hÃ¡bitos financieros (Finanzas)",
    "ğŸ§© Ejercitar tu memoria y agilidad mental (Agilidad)"
  ]
};

// ==========================
// Mapear los modos internos a etiquetas exactas del Form
// ==========================
const MODE_LABELS = {
  LOW:   "Low Mood ğŸª« - Quiero un cambio, pero no tengo la energia",
  CHILL: "Chill Mood ğŸŒ¿ - Estoy  bien, quiero trackear mis hÃ¡bitos",
  FLOW:  "Flow Mood ğŸŒŠ - Tengo un objetivo y quiero comenzar esta aventura",
  EVOLVE:"Evolve Mood ğŸ§¬ - Estoy enfocado y quiero ir al prÃ³ximo nivel"
};
</script>


<script>
// ==========================
// 2) LÃ³gica UI + XP + rutas
// ==========================
document.addEventListener('DOMContentLoaded', () => {
  // Estado
  const xp = { Body:0, Mind:0, Soul:0, total:0 };
  const answers = {
    email:"",
    mode:null,
    low:{ body:[], soul:[], mind:[], note:"" },
    chill:{ oneThing:"", motiv:[] },
    flow:{ goal:"", imped:[] },
    evolve:{ goal:"", trade:[], att:"" },
    foundations:{ body:[], soul:[], mind:[], bodyOpen:"", soulOpen:"", mindOpen:"" }
  };

  const routes = {
    LOW: ["scr-low-body","scr-low-soul","scr-low-mind","scr-low-note","scr-summary"],
    CHILL: ["scr-chill-open","scr-chill-motiv","scr-f-body","scr-f-soul","scr-f-mind","scr-summary"],
    FLOW: ["scr-flow-goal","scr-flow-imped","scr-f-body","scr-f-soul","scr-f-mind","scr-summary"],
    EVOLVE:["scr-evolve-goal","scr-evolve-trade","scr-evolve-att","scr-f-body","scr-f-soul","scr-f-mind","scr-summary"]
  };
  let routeScreens = []; let stepIndex = 0;

  // Helpers
  const $  = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const $go = id => document.getElementById(id);
  const show = id => { $$(".scr").forEach(s=>s.classList.remove("active")); $("#"+id).classList.add("active"); drawProgress(); };
  const toast = (txt) => { const t=$("#toast"); if(!t) return; t.textContent=txt; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1100); };

  function drawProgress(){
    const total = routeScreens.length;
    let pct = 0;
    if (total > 1) pct = Math.min(100, Math.max(0, Math.round((stepIndex)/(total-1)*100)));
    const pf = $("#progressFill"); if (pf) pf.style.width = pct + "%";

    const b = Math.round(xp.Body), m = Math.round(xp.Mind), s = Math.round(xp.Soul);
    const barB = $("#barBody"), barM = $("#barMind"), barS = $("#barSoul");
    if (barB) barB.value = Math.min(b,100);
    if (barM) barM.value = Math.min(m,100);
    if (barS) barS.value = Math.min(s,100);

    const totalEl = $("#xpTotal"); const shown = b + m + s;
    if (totalEl) totalEl.textContent = shown;
    xp.total = shown;
  }

  function addXP(amount, pillar){
    if (amount <= 0) return;
    const fix = n => Math.round(n * 100) / 100;
    if (pillar === "ALL") ["Body","Mind","Soul"].forEach(p => { xp[p] = fix(xp[p] + amount/3); });
    else xp[pillar] = fix(xp[pillar] + amount);
    xp.total = fix(xp.Body + xp.Mind + xp.Soul);
    drawProgress();
  }

  // Pintado de listas
  function paintChecklist(listId, items, type="checkbox", nameGroup="grp"){
    const host = document.getElementById(listId);
    if (!host) return;
    host.innerHTML = "";
    items.forEach((txt,i)=>{
      const id = `${listId}-${i}`;
      const input = document.createElement("input");
      input.type = type;
      if(type==="radio") input.name = nameGroup;
      input.id = id;
      const label = document.createElement("label");
      label.className = "chip"; label.setAttribute("for", id);
      label.appendChild(input);
      const span = document.createElement("span"); span.textContent = txt; label.appendChild(span);
      host.appendChild(label);
    });
  }

  // Fuente Ãºnica â†’ UI
  const LISTS = {
    lowBody: FORM_LABELS.lowBody,
    lowSoul: FORM_LABELS.lowSoul,
    lowMind: FORM_LABELS.lowMind,
    chillMotiv: FORM_LABELS.chillMotiv,
    flowImped: FORM_LABELS.flowObstacles,
    evolveTrade: FORM_LABELS.evolveCommit,
    evolveAtt: FORM_LABELS.evolveAtt,
    fBody: FORM_LABELS.fBody,
    fSoul: FORM_LABELS.fSoul,
    fMind: FORM_LABELS.fMind
  };

  // Textareas "open" de Foundations para sumar +21 si tienen contenido
  const OPEN_FOUND = {
    "scr-f-body": "fBodyOpen2",
    "scr-f-soul": "fSoulOpen2",
    "scr-f-mind": "fMindOpen2"
  };

  // Pintar todas
  paintChecklist("lowBodyList", LISTS.lowBody);
  paintChecklist("lowSoulList", LISTS.lowSoul);
  paintChecklist("lowMindList", LISTS.lowMind);
  paintChecklist("fBodyList",   LISTS.fBody);
  paintChecklist("fSoulList",   LISTS.fSoul);
  paintChecklist("fMindList",   LISTS.fMind);
  paintChecklist("chillMotivList", LISTS.chillMotiv);
  paintChecklist("flowImpedList",  LISTS.flowImped);
  paintChecklist("evolveTradeList", LISTS.evolveTrade);
  paintChecklist("evolveAttList",   LISTS.evolveAtt, "radio", "evolveAtt");

  // Ejecuta acciÃ³n solo la 1Âª vez (usa data-done en la <section>)
  function doOnce(sectionId, fn) {
    const sec = document.getElementById(sectionId);
    if (!sec) return;
    if (sec.dataset.done === "1") { nextStep(); return; }
    fn();
    sec.dataset.done = "1";
    nextStep();
  }

  // Reset total
  function resetAll(){
    xp.Body = xp.Mind = xp.Soul = xp.total = 0;
    answers.email = ""; answers.mode = null;
    answers.low   = { body:[], soul:[], mind:[], note:"" };
    answers.chill = { oneThing:"", motiv:[] };
    answers.flow  = { goal:"", imped:[] };
    answers.evolve= { goal:"", trade:[], att:"" };
    answers.foundations = { body:[], soul:[], mind:[], bodyOpen:"", soulOpen:"", mindOpen:"" };

    document.querySelectorAll("input[type=email], input[type=text], textarea").forEach(el => el.value = "");
    document.querySelectorAll("input[type=checkbox], input[type=radio]").forEach(el => el.checked = false);
    document.querySelectorAll(".card.selected").forEach(c => c.classList.remove("selected"));
    ["confirmMode","confirmChillOpen","confirmFlowGoal","confirmEvolveGoal",
     "confirmChillMotiv","confirmFlowImped","confirmEvolveTrade","confirmEvolveAtt",
     "confirmLowBody","confirmLowSoul","confirmLowMind","confirmFBody","confirmFSoul","confirmFMind"]
      .forEach(id => { const b=document.getElementById(id); if(b) b.disabled = true; });
    document.querySelectorAll(".scr").forEach(s => delete s.dataset.done);

    const totalEl = $("#xpTotal"); if (totalEl) totalEl.textContent = "0";
    ["barBody","barMind","barSoul"].forEach(id => { const p=$go(id); if(p) p.value=0; });
    const fill = $("#progressFill"); if (fill) fill.style.width = "0%";

    routeScreens = []; stepIndex = 0; show("scr-intro");
  }

  // NavegaciÃ³n base
  const nextStep = ()=>{
    const next = Math.min(routeScreens.length - 1, stepIndex + 1);
    const target = routeScreens[next];
    if (!target) return;
    stepIndex = next;
    show(target);
    if (target === "scr-summary") renderSummary();
  };
  const prevStep = ()=>{
    stepIndex = Math.max(0, stepIndex - 1);
    show(routeScreens[stepIndex]);
  };

  // HUD: volver al landing
  $go("hudTitle")?.addEventListener("click", ()=>{
    if (!xp.total || confirm("Â¿Salir y volver al inicio? Se perderÃ¡ el progreso.")) {
      window.location.href = "https://rfullivarri.github.io/gamificationweblanding/indexv2.html";
    }
  });

  // Back a intro (IDs alternativos)
  const backIntroBtn = $go("backIntro") || $go("backToIntro");
  if (backIntroBtn) backIntroBtn.addEventListener("click", ()=> show("scr-intro"));

  // ===== Email Intro â€” estable (sin loops) =====
  (() => {
    const emailInput = $go('emailInput');
    const goBtn      = $go('goModes');
    if (!emailInput || !goBtn) return;

    if (String(goBtn.tagName).toUpperCase() === 'BUTTON') goBtn.type = 'button';

    const norm    = v => String(v || '').trim().toLowerCase();
    const isEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

    function setEnabled(ok){
      const wantDisabled = !ok;
      if (goBtn.disabled !== wantDisabled) goBtn.disabled = wantDisabled;
      if (ok && goBtn.hasAttribute('disabled')) goBtn.removeAttribute('disabled');
    }
    function save(v){
      try { if (typeof answers !== 'undefined' && answers) answers.email = v; } catch(e){}
      window.GJ_EMAIL = v;
    }
    function refresh(){
      const v  = norm(emailInput.value);
      const ok = isEmail(v);
      setEnabled(ok);
      save(v);
    }

    let raf = 0;
    const schedule = () => { cancelAnimationFrame(raf); raf = requestAnimationFrame(refresh); };
    ['input','change','paste','blur','compositionend'].forEach(ev => emailInput.addEventListener(ev, schedule));

    let tries = 0;
    const boot = setInterval(() => { schedule(); if (++tries > 20) clearInterval(boot); }, 150);

    goBtn.addEventListener('click', (e) => {
      refresh();
      const v = norm(emailInput.value);
      if (!isEmail(v)) { (typeof toast==='function' ? toast('PonÃ© un correo vÃ¡lido âœ‰') : alert('PonÃ© un correo vÃ¡lido âœ‰')); e.preventDefault(); return; }
      save(v);
      show('scr-modes');
    });

    refresh();
  })();

  // ===== Elegir modo =====
  $$("#modeGrid .card").forEach(card=>{
    card.addEventListener("click", ()=>{
      $$("#modeGrid .card").forEach(c=>c.classList.remove("selected"));
      card.classList.add("selected");
      answers.mode = card.dataset.mode;
      const cm = $go("confirmMode"); if (cm) cm.disabled = false;
    });
  });
  $go("confirmMode")?.addEventListener("click", ()=>{
    routeScreens = routes[answers.mode];
    stepIndex = 0;
    show(routeScreens[stepIndex]);
  });

  // Volver a modes
  ["backToModes1","backToModes2","backToModes3","backToModes4"].forEach(id=>{
    $go(id)?.addEventListener("click", ()=> show("scr-modes"));
  });

  // BACKS Foundations (Body â†’ Soul â†’ Mind)
  ["backFoundPrev1","backFBody","backFSoul"].forEach(id => {
    const btn = $go(id); if (!btn) return;
    btn.addEventListener("click", () => { stepIndex = Math.max(0, stepIndex - 1); show(routeScreens[stepIndex]); });
  });

  // Utils selecciÃ³n
  const getCheckedTexts = sel => $$(sel+" input:checked").map(i=>i.parentElement.textContent.trim());
  const getRadioText   = sel => { const el = $$(sel+" input[type=radio]").find(i=>i.checked); return el?el.parentElement.textContent.trim():""; };

  // Checklist con lÃ­mite y confirm (+ opcional "open" con +21 XP)
  function bindLimitedChecklist(scrId, listId, countId, storeArrRef, openTextareaId=null){
    const sec    = $go(scrId); if (!sec) return;
    const max    = Number(sec.dataset.limit || 5);
    const inputs = $$("#"+listId+" input");
    const count  = $go(countId);

    function confirmIdFor(id){
      return ({
        "scr-low-body":"confirmLowBody","scr-low-soul":"confirmLowSoul","scr-low-mind":"confirmLowMind",
        "scr-f-body":"confirmFBody","scr-f-soul":"confirmFSoul","scr-f-mind":"confirmFMind"
      })[id];
    }
    const confirmBtn = $go(confirmIdFor(scrId)); if (!confirmBtn) return;

    function update(){
      const ch = inputs.filter(i=>i.checked);
      if(ch.length > max){ ch[ch.length-1].checked = false; }
      const now = inputs.filter(i=>i.checked).length;
      if (count) count.textContent = now;
      confirmBtn.disabled = (now < 1);
    }
    inputs.forEach(i=> i.addEventListener("change", update));
    update();

    confirmBtn.addEventListener("click", ()=>{
      // Open (texto) â†’ +21 ALL solo la 1Âª vez con contenido
      if (openTextareaId){
        const val = ($go(openTextareaId)?.value || "").trim();
        const keyMap = {
          "scr-f-body":"bodyOpen", "scr-f-soul":"soulOpen", "scr-f-mind":"mindOpen",
          "scr-low-body":"bodyOpen","scr-low-soul":"soulOpen","scr-low-mind":"mindOpen"
        };
        const k = keyMap[scrId];
        if (k) answers.foundations[k] = val;
        if (val && sec.dataset.openDone !== "1"){
          addXP(21,"ALL"); toast("+21 XP"); sec.dataset.openDone = "1";
        }
      }

      // Checklist: 1Âª vez guarda y suma +13 al pilar
      if (sec.dataset.done !== "1"){
        storeArrRef.length = 0;
        getCheckedTexts("#"+listId).forEach(t=>storeArrRef.push(t));
        const xpVal = Number(sec.dataset.xp || 13);
        const pillar = sec.dataset.pillar;
        addXP(xpVal, pillar); toast(`+${xpVal} XP`);
        sec.dataset.done = "1";
      }
      nextStep();
    });
  }

  // Binds LOW + FOUNDATIONS
  bindLimitedChecklist("scr-low-body","lowBodyList","lowBodyCount",   answers.low.body, "fBodyOpen");
  bindLimitedChecklist("scr-low-soul","lowSoulList","lowSoulCount",   answers.low.soul, "fSoulOpen");
  bindLimitedChecklist("scr-low-mind","lowMindList","lowMindCount",   answers.low.mind, "fMindOpen");
  bindLimitedChecklist("scr-f-body",  "fBodyList",  "fBodyCount",     answers.foundations.body, "fBodyOpen2");
  bindLimitedChecklist("scr-f-soul",  "fSoulList",  "fSoulCount",     answers.foundations.soul, "fSoulOpen2");
  bindLimitedChecklist("scr-f-mind",  "fMindList",  "fMindCount",     answers.foundations.mind, "fMindOpen2");

  // LOW note (+21 si escribiÃ³ algo)
  $go("backLowMind")?.addEventListener("click", ()=> prevStep());
  $go("confirmLowNote")?.addEventListener("click", ()=>{
    doOnce("scr-low-note", ()=>{
      answers.low.note = ($go("lowNote")?.value || "").trim();
      if (answers.low.note) { const xpVal = Number($go("scr-low-note")?.dataset?.xp || 21); addXP(xpVal,"ALL"); toast(`+${xpVal} XP`); }
    });
  });

  // ---------- CHILL ----------
  $go("chillOneThing")?.addEventListener("input", ()=> {
    const v = ($go("chillOneThing")?.value || "").trim();
    const b = $go("confirmChillOpen"); if (b) b.disabled = (v.length < 1);
  });
  $go("confirmChillOpen")?.addEventListener("click", ()=>{
    doOnce("scr-chill-open", ()=>{
      answers.chill.oneThing = ($go("chillOneThing")?.value || "").trim();
      addXP(21, "ALL"); toast("+21 XP");
    });
  });
  const chillInputs = $$("#chillMotivList input");
  const updateChill = ()=> { const b=$go("confirmChillMotiv"); if (b) b.disabled = chillInputs.filter(i=>i.checked).length < 1; };
  chillInputs.forEach(i=> i.addEventListener("change", updateChill)); updateChill();
  $go("confirmChillMotiv")?.addEventListener("click", ()=>{
    doOnce("scr-chill-motiv", ()=>{
      answers.chill.motiv = getCheckedTexts("#chillMotivList");
      addXP(13, "ALL"); toast("+13 XP");
    });
  });
  $go("backChillOpen")?.addEventListener("click", ()=> prevStep());

  // ---------- FLOW ----------
  $go("flowGoal")?.addEventListener("input", ()=> {
    const v = ($go("flowGoal")?.value || "").trim();
    const b = $go("confirmFlowGoal"); if (b) b.disabled = (v.length < 1);
  });
  $go("confirmFlowGoal")?.addEventListener("click", ()=>{
    doOnce("scr-flow-goal", ()=>{
      answers.flow.goal = ($go("flowGoal")?.value || "").trim();
      addXP(21, "ALL"); toast("+21 XP");
    });
  });
  const flowImps = $$("#flowImpedList input");
  const updateFlow = ()=> { const b=$go("confirmFlowImped"); if (b) b.disabled = flowImps.filter(i=>i.checked).length < 1; };
  flowImps.forEach(i=> i.addEventListener("change", updateFlow)); updateFlow();
  $go("confirmFlowImped")?.addEventListener("click", ()=>{
    doOnce("scr-flow-imped", ()=>{
      answers.flow.imped = getCheckedTexts("#flowImpedList");
      addXP(13, "ALL"); toast("+13 XP");
    });
  });
  $go("backFlowGoal")?.addEventListener("click", ()=> prevStep());

  // ---------- EVOLVE ----------
  $go("evolveGoal")?.addEventListener("input", ()=> {
    const v = ($go("evolveGoal")?.value || "").trim();
    const b = $go("confirmEvolveGoal"); if (b) b.disabled = (v.length < 1);
  });
  $go("confirmEvolveGoal")?.addEventListener("click", ()=>{
    doOnce("scr-evolve-goal", ()=>{
      answers.evolve.goal = ($go("evolveGoal")?.value || "").trim();
      addXP(21, "ALL"); toast("+21 XP");
    });
  });
  const evTrade = $$("#evolveTradeList input");
  const updEvTrade = ()=> { const b=$go("confirmEvolveTrade"); if (b) b.disabled = evTrade.filter(i=>i.checked).length < 1; };
  evTrade.forEach(i=> i.addEventListener("change", updEvTrade)); updEvTrade();
  $go("confirmEvolveTrade")?.addEventListener("click", ()=>{
    doOnce("scr-evolve-trade", ()=>{
      answers.evolve.trade = getCheckedTexts("#evolveTradeList");
      addXP(13, "ALL"); toast("+13 XP");
    });
  });
  const evAtt = $$("#evolveAttList input");
  evAtt.forEach(i=> i.addEventListener("change", ()=> { const b=$go("confirmEvolveAtt"); if (b) b.disabled = !evAtt.some(x=>x.checked); }));
  $go("confirmEvolveAtt")?.addEventListener("click", ()=>{
    doOnce("scr-evolve-att", ()=>{
      answers.evolve.att = getRadioText("#evolveAttList");
      addXP(21, "ALL"); toast("+21 XP");
    });
  });
  $go("backEvolveTrade")?.addEventListener("click", ()=> prevStep());

  // Atajos teclado
  document.addEventListener("keydown",(e)=>{
    if(e.key==="ArrowLeft")  prevStep();
    if(e.key==="ArrowRight") nextStep();
  });

  // Resumen
  function renderSummary(){
    const box = $("#summaryBox"); if (!box) return;
    const fmt = a => (a && a.length)? a.join(", ") : "â€”";
    box.innerHTML = `
      <div><strong>Game Mode:</strong> ${answers.mode||"â€”"}</div>
      <div><strong>Email:</strong> ${answers.email||"â€”"}</div>
      <hr style="border:0;border-top:1px solid var(--ring);margin:8px 0">
      ${
        answers.mode==="LOW"
        ? `
          <div><strong>LOW Â· Body:</strong> ${fmt(answers.low.body)}</div>
          <div><strong>LOW Â· Soul:</strong> ${fmt(answers.low.soul)}</div>
          <div><strong>LOW Â· Mind:</strong> ${fmt(answers.low.mind)}</div>
          ${answers.low.note?`<div><strong>Nota:</strong> ${answers.low.note}</div>`:""}
        `
        : `
          ${answers.mode==="CHILL" ? `<div><strong>CHILL Â· Objetivo:</strong> ${answers.chill.oneThing}</div>
          <div><strong>CHILL Â· Motivaciones:</strong> ${fmt(answers.chill.motiv)}</div>`:""}
          ${answers.mode==="FLOW" ? `<div><strong>FLOW Â· Objetivo:</strong> ${answers.flow.goal}</div>
          <div><strong>FLOW Â· Impedimentos:</strong> ${fmt(answers.flow.imped)}</div>`:""}
          ${answers.mode==="EVOLVE" ? `<div><strong>EVOLVE Â· Objetivo:</strong> ${answers.evolve.goal}</div>
          <div><strong>EVOLVE Â· Ajustes:</strong> ${fmt(answers.evolve.trade)}</div>
          <div><strong>EVOLVE Â· Actitud:</strong> ${answers.evolve.att}</div>`:""}
          <hr style="border:0;border-top:1px solid var(--ring);margin:8px 0">
          <div><strong>Foundations Â· Body:</strong> ${fmt(answers.foundations.body)}</div>
          <div><strong>Foundations Â· Soul:</strong> ${fmt(answers.foundations.soul)}</div>
          <div><strong>Foundations Â· Mind:</strong> ${fmt(answers.foundations.mind)}</div>
        `
      }
      <hr style="border:0;border-top:1px solid var(--ring);margin:8px 0">
      <div><strong>ğŸ«€ Body:</strong> ${Math.round(xp.Body)} XP</div>
      <div><strong>ğŸ§  Mind:</strong> ${Math.round(xp.Mind)} XP</div>
      <div><strong>ğŸµï¸ Soul:</strong> ${Math.round(xp.Soul)} XP</div>
      <div style="margin-top:6px"><strong>Total:</strong> ${Math.round(xp.total)} XP</div>
    `;
  }

  // BotÃ³n "Volver al inicio" del resumen
  $go("restart")?.addEventListener("click", resetAll);

  // Init
  drawProgress();
  window.JOURNEY_STATE = { get answers(){ return answers; }, get xp(){ return xp; } };
});
</script>
  
<!------------------------> 
<!-- payload.builder.js -->
<!-- ------------------ -->
  
<script>
(() => {
  const keyCID = 'gj_client_id';

  function getClientId(){
    try{
      let cid = localStorage.getItem(keyCID);
      if (!cid) {
        cid = (crypto && crypto.randomUUID) ? crypto.randomUUID()
             : 'cid-' + Math.random().toString(36).slice(2) + Date.now();
        localStorage.setItem(keyCID, cid);
      }
      return cid;
    }catch(_){
      return 'cid-' + Date.now();
    }
  }

  function normEmail(v){ return String(v||'').trim().toLowerCase(); }

  function meta(){
    let tz = '';
    try { tz = Intl.DateTimeFormat().resolvedOptions().timeZone || ''; } catch(_){}
    const lang = (navigator.language || '').toLowerCase();
    const ua = (navigator.userAgent || '').toLowerCase();
    const device = /mobi|android/.test(ua) ? 'mobile' : 'desktop';
    return { tz, lang, device, version:'formsintrov2' };
  }

  function safeAnswers(){ return (window.JOURNEY_STATE && window.JOURNEY_STATE.answers) ? window.JOURNEY_STATE.answers : {}; }
  function safeXP(){ return (window.JOURNEY_STATE && window.JOURNEY_STATE.xp) ? window.JOURNEY_STATE.xp : {Body:0,Mind:0,Soul:0,total:0}; }

  function build(){
    const a = safeAnswers();
    const xp = safeXP();

    return {
      ts: new Date().toISOString(),
      client_id: getClientId(),
      email: normEmail(a.email),
      mode: String(a.mode || '').toUpperCase(),      // LOW|CHILL|FLOW|EVOLVE
      // mode_label: (opcional; la WebApp lo infiere si no lo mandamos)
      data: {
        low:   { body: a.low?.body||[],  soul: a.low?.soul||[],  mind: a.low?.mind||[],  note: a.low?.note||'' },
        chill: { oneThing: a.chill?.oneThing||'', motiv: a.chill?.motiv||[] },
        flow:  { goal: a.flow?.goal||'',  imped: a.flow?.imped||[] },
        evolve:{ goal: a.evolve?.goal||'', trade: a.evolve?.trade||[], att: a.evolve?.att||'' },
        foundations: {
          body: a.foundations?.body||[], soul: a.foundations?.soul||[], mind: a.foundations?.mind||[],
          bodyOpen: a.foundations?.bodyOpen||'', soulOpen: a.foundations?.soulOpen||'', mindOpen: a.foundations?.mindOpen||''
        }
      },
      xp: {
        total: Number(xp.total||0),
        Body:  Number(xp.Body||0),
        Mind:  Number(xp.Mind||0),
        Soul:  Number(xp.Soul||0)
      },
      meta: meta()
    };
  }

  // Exponer builder
  window.GJPayload = { build };
})();
</script>
  
<!------------------------> 
<!-- onboarding.client.js -->
<!-- ------------------ -->
<!-- <script>
(() => {
  const WORKER_URL = 'https://gamificationonboarding.rfullivarri22.workers.dev/'; // â¬…ï¸ REEMPLAZAR

  const btn = document.getElementById('finish');
  if (!btn) return;

  let sending = false;

  function notify(msg){
    if (typeof toast === 'function') toast(msg);
    else alert(msg);
  }

  async function send(){
    if (sending) return;
    sending = true;
    btn.disabled = true;

    try{
      const payload = (window.GJPayload && window.GJPayload.build) ? window.GJPayload.build() : null;
      if (!payload) throw new Error('No se pudo construir el payload');
      if (!payload.email) throw new Error('Falta email');
      if (!payload.mode)  throw new Error('Falta modo');

      const res = await fetch(WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      let data = {};
      try { data = await res.json(); } catch(_){}

      if (!res.ok || data.ok === false){
        throw new Error(data.error || ('HTTP '+res.status));
      }

      notify('Â¡Enviado! Estamos creando tu tablero âœ¨');
      // (opcional) acÃ¡ podÃ©s redirigir a otra vista o deshabilitar permanentemente el botÃ³n
    }catch(err){
      console.error('Onboarding send error:', err);
      notify('Ups, no pudimos enviar. ProbÃ¡ de nuevo.');
      btn.disabled = false;
      sending = false;
      return;
    }

    // Ã©xito: mantener deshabilitado para evitar duplicados
  }

  btn.addEventListener('click', send);
})();
</script> -->

  
<!-- onboarding.client.js -->
<script>
(() => {
  const WORKER_URL   = 'https://gamificationonboarding.rfullivarri22.workers.dev/'; // <-- tu worker, con slash final
  const REDIRECT_URL = 'https://rfullivarri.github.io/gamificationweblanding/loginv2.html?await=1';

  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('finish');
    if (!btn) { console.warn('[onboarding] #finish no encontrado'); return; }

    let sending = false;

    const setLoading = (on, label) => {
      if (on) {
        btn.disabled = true;
        btn.classList.add('loading');      // tu CSS del spinner
        btn.setAttribute('aria-busy','true');
        if (label) btn.textContent = label;
      } else {
        btn.classList.remove('loading');
        btn.removeAttribute('aria-busy');
        btn.disabled = false;
      }
    };

    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (sending) return;
      sending = true;

      const oldTxt = btn.textContent;
      setLoading(true, 'Enviandoâ€¦');

      try {
        const payload = window.GJPayload?.build?.();
        if (!payload) throw new Error('payload_build_failed');
        if (!payload.email) throw new Error('email_required');
        if (!payload.mode)  throw new Error('mode_required');

        const res = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        let data = {};
        try { data = await res.json(); } catch(_) {}
        if (!res.ok || data.ok === false) {
          throw new Error(data?.error || `HTTP ${res.status}`);
        }

        // Guarda contexto para WAIT1 (opcional)
        try {
          sessionStorage.setItem('gj_email', payload.email || '');
          sessionStorage.setItem('gj_client_id', data.client_id || payload.client_id || '');
          window._lastClientId = data.client_id || payload.client_id || '';
        } catch(_) {}

        // Redirige sin pop-up
        window.location.href = REDIRECT_URL;
        // Nota: no â€œdesbloqueamosâ€ el botÃ³n para evitar re-envÃ­os mientras navega

      } catch (err) {
        console.error('[onboarding] send error:', err);
        (typeof toast === 'function'
          ? toast('No pudimos enviar. ProbÃ¡ de nuevo.')
          : alert('No pudimos enviar. ProbÃ¡ de nuevo.')
        );
        setLoading(false);
        btn.textContent = oldTxt;
        sending = false;
      }
    });
  });
})();
</script>
</body>
</html>
